---
output:
  html_document: default
  pdf_document: default
---

---
title: "Rules & Tenure Models"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

-2021-6-17 : add code to create a DV for others' pastures, but this should eventually be moved to 1_RTM_datapull

-2021-4-6 :  Updated the best fit models with optimizer and increased iterations and don't get error now.

-2020-2-1 :  This is a new version of RulesModelReport. That doc contained all of the second wave of comparison models, particularly wrt ordinal vs. DV for Rules. This version is the final models, so we can generate final figures and tables in here without all of the extra stuff.
-2020-01-31: Best fits to use for table:hypw, hyps, hypwotr, 

-2020-01-22: versioned the prior iteration of this that included manual calculation of predicted vals/effect sizes for all the params. can do that w sjPlot more quickly. 
-2019-12-6: versioned the prior iteration of this that included all the old model comparisons and restarted w new based on the new tabel of hypothesized relationships from our call on Dec. 5

TO DO:
- Set some global viz params to use for plots below.

```{r setup, echo = FALSE, message = FALSE, include = FALSE, warning= FALSE, cache= TRUE}
library(haven)  # this is the new package to use instead of (foreign)
#library(corrplot)
library(magrittr)
library(tidyr)
library(dplyr)
library(ggplot2)
library(readxl)
library(knitr)
library(summarytools)
library(lme4)
library(sjPlot)
library(sjmisc)
library(stringr)
library(kableExtra)
library(qwraps2)
library(fmsb)

options(scipen = 999)

# This is pulled from the vignette for the summarytools pkg, which gives
# these suggested specifications to enable easy viewing of outputs:
# https://cran.r-project.org/web/packages/summarytools/vignettes/Introduction.html

opts_chunk$set(results = 'asis',      # This is essential (can also be set at the chunk-level)
                comment = NA, 
                prompt = FALSE, 
                cache = FALSE, # additional global settings I want to have for this doc:
                message = FALSE,
                warning = FALSE)

st_options(plain.ascii = FALSE,        # This is very handy in all Rmd documents
            style = "rmarkdown",        # This too
            footnote = NA,             # Avoids footnotes which would clutter the results
            subtitle.emphasis = FALSE  # This is a setting to experiment with - according tothe theme used, it might improve the headings layout
           )   

```

```{r, echo=FALSE, message=FALSE}
# this setting also also suggested from summarytools vignette:
st_css()                              # This is a must; without it, expect odd layout,
                                      # especially with dfSummary()

theme_set(theme_sjplot())
```

---- Data prep now located in 1_RTM-datapull.R: (hidden in report view)  
< not including Use params in the dataframe called td now >
That script does the following:
1. Everything is straight factors, num or chr except for Rules which is ordered.
2. Recodes household-level tenure vars:  
3. Per discussion on Jan 7 2018, have condensed use & possession responses in to one category. 
4. Adds dummy Vars for Rules : [this is only useful for a few of the models]
5. Creates a subset of the df that removes all records w/ NAs in Social capital
---- Data exploration and cross tabs now located in 2_RTM_dataexplore.R
 That script does the following:
1. basic cross tabs and chisq tests for assoc btwn model params


# Load Rdata files 
```{r, echo = FALSE}
load("./data/td.RData")

td.fg$Soum <- as.factor(td.fg$Soum)
td.fg$Aimag <- as.factor(td.fg$Aimag)
td.fg$Org <- as.factor(td.fg$Org)
#td.fg%<>% mutate(frg.left = (100-frgUse)) %>% rename(frgCV = CV)

# create a dummy variable for others' Pastures
td.fg <- mutate(td.fg, othersIn = case_when(otherPast == 1 ~ 0, 
                                              # set others to zero
                                            otherPast == 2 ~ 1,
                                            otherPast == 3 ~ 0, 
                                        # access within soum = 1
                                         TRUE ~ NA_real_))            # else NA

td.fg <- mutate(td.fg, othersOut = case_when( otherPast == 1 | otherPast == 2 ~ 0,   # set others to zero
                                              otherPast == 3 ~ 1,   # access in other soums = 1
                                       TRUE ~ NA_real_))            # else NA

td.fg %<>% mutate_at(c(33:34), funs(factor(.)))

```

# MODELS:
# placeholder for formula code:
*Eq. 1*: $y_{ij} = \gamma_{00} + U_{0j}$

where $y_i$ is the dependent variable measured at houhold $i$ in organization $j$. Model 1 was used as the baseline model to estimate the group-level variance in the dependent variable. We compared each model to an intercept-only model and models w random intercepts performed better in both instances.


*Eq. 2*: $y^*_{ij} = x_{ij}'\beta + u_i + \epsilon_{ij}$,




### 2.1 Null Model & random effects
Determining support for specifying random effect for Organization. 
[We are going w Org, not Soum bc we have a hypothesis re: more var in herder practices between Orgs than within]

#Null models for all response vars: Intercept only-models.
steps Ref'd from http://data.princeton.edu/wws509/R/c3s1.html
the estimate of the constant is the logit of the proportion Reservign Pastures:
```{r}
nullw<-  glm( ResWint ~ 1, data=td.fg, family=binomial)
nulls<- glm( ResSpr ~1, data= td.fg, family = binomial)
nullwo<- glm( Wotor ~1, data= td.fg, family = binomial)
nullfo<- glm( Fotor ~1, data= td.fg, family = binomial)

```
Null w/ only the grouping factor specified
```{r}
nullw1<-  glmer( ResWint ~ 1 + (1|Org), data=td.fg, family=binomial)
nulls1<- glmer( ResSpr ~1 + (1|Org), data= td.fg, family = binomial)
nullwo1<- glmer( Wotor ~1 + (1|Org), data= td.fg, family = binomial)
nullfo1<- glmer( Fotor ~1 + (1|Org), data= td.fg, family = binomial)
```

Display a tabel of null models:
```{r}
tab_model(nullw1, nulls1, nullwo1, nullfo1,
          show.aic= TRUE,
          show.icc= FALSE,
          dv.labels = c("Reserve Winter", "Reserve Spring", "Winter otor", "Fall otor")
          )
```


 


```{r, eval = FALSE, echo = FALSE}
# old code i'm keeping in case we want to plot it again: 
# for examining the original and predicted values. 
# To visualize will have to decide a cut-off point for the fitted to assign 0/1
df.htm7<- htm7@frame
wDat <- data.frame(htm7@frame, resid=residuals(htm7,type="pearson"),fitted=fitted(htm7))

theme= theme(panel.grid.major = element_blank(),
             panel.grid.minor = element_blank(),
             panel.background = element_blank(),
             axis.text.y = element_blank(),
             axis.ticks = element_blank(),
             axis.line.x = element_line(color = "black"),
             axis.line.y = element_line(color = "black"),
             text = element_text(size = 20),
             legend.key = element_blank())
hist <- ggplot(wDat, aes(fitted, color = ResWint, fill = ResWint))
hist +
  theme +
  geom_dotplot(binwidth = 0.01, position = "jitter")+
  coord_cartesian(xlim = c(0,1))+
  xlab("Predicted value")+
  ylab(" ")+
  scale_color_manual(values = c("Maroon", "#2C3539"), #change
                     labels = c("Do Not Reserve", "Reserve"),
                     name = "Winter Pastures")+
  scale_fill_manual(values = c("Maroon", "#2C3539"), #change
                     labels = c("Do Not Reserve", "Reserve"),
                     name = "Winter Pastures")+
  geom_vline(xintercept = c(0.5), linetype = "dotdash", size = 1)

##### Let's explore the values w high predicted value but observed = 0 to see what's up. 

# filter the df of predicted vals it so it's the values on the right that were obsv No, pred Yes and look at summary stats:
#wDat%>%dplyr::filter(fitted >= 0.5) %>% filter(ResWint == 0) %>% summary_table(.)
badpred <- wDat%>%dplyr::filter(fitted >= 0.5) %>% filter(ResWint == 0)
# let's compare those to the summary stats for the correctly predicted:
#wDat%>%dplyr::filter(fitted >= 0.5) %>% filter(ResWint == 1) %>% summary_table(.)
goodpred <- wDat%>%dplyr::filter(fitted >= 0.5) %>% filter(ResWint == 1)


# merge w the original data so can visualize by EZ:

#wDat.td<- left_join(wDat, td, by = "Org")


#ggplot(badpred, aes(fitted))+geom_density()+theme_bw()

# histogram of predicted values, colored by Rule formality 
ggplot(badpred, aes(fitted, color= Rule)) + geom_density() 
# ggplot(wDat, aes(fitted, color= hhTenureWPast)) + geom_density() 
# ggplot(wDat, aes(fitted, color= hhTenureWCamp)) + geom_density() 
# ggplot(wDat, aes(fitted, color= ResWint)) + geom_density() 
```

##2.2
The base models with all params included.
```{r, message=FALSE}
wp <- glmer(ResWint ~ hhTenureWPast + hhTenureWCamp + RuleYes +  cogSC1 + bondSC + otherPast + frg.left + frgCV + (1|Org) , family = binomial, data = td.fg) 
sp <- glmer(ResSpr ~ hhTenureSpPast + hhTenureSpCamp + RuleYes +  cogSC1 + bondSC + otherPast + frg.left + frgCV + (1|Org) , family = binomial, data = td.fg) 
wo <- glmer(Wotor ~ hhTenureWPast + hhTenureWCamp + RuleYes +  cogSC1 + bondSC + otherPast + frg.left + frgCV + (1|Org) , family = binomial, data = td.fg) 
fo <- glmer(Fotor ~ hhTenureWPast + hhTenureWCamp + RuleYes +  cogSC1 + bondSC + otherPast + frg.left + frgCV + (1|Org) , family = binomial, data = td.fg) 

```

FULL SET OF PARAMETERS COMPARED ALL TOGETHER:
Not actually realistic, as not all hypothesized to be significant for each outcome, plus end up w very reduced sample size, but here for comparison.
```{r}
tab_model(wp, sp, wo, fo, 
          show.aic = TRUE, 
          show.icc = TRUE,
          dv.labels = c("Reserve Winter", "Reserve Spring", "Winter otor", "Fall otor"))
```


#3. MODEL COMPARISONS:

TO DO: a Supp Table that is just the hypothesized signif terms, not the best fit, which is what is below:

Best fit models combined in to one table:


```{r}
# Resv Wtr
hypw<- glmer(ResWint ~ hhTenureWPast + 
               hhTenureWCamp + 
               RuleYes + 
               RuleFormal+  
               cogSC1 + 
               frgCV + 
               frg.left +   (1|Org) , family = binomial, data = td.fg) 

  #MODEL CONVERGES IF CHANGE THE OPTIMIZER AND UP THE ITERATIONS
ss <- getME(hypw,c("theta","fixef"))
w1 <- update(hypw,start=ss,control=glmerControl(optimizer="bobyqa",
                                                 optCtrl=list(maxfun=2e5)))

# Resv Spr
hyps<- glmer(ResSpr ~ hhTenureSpPast + 
               hhTenureSpCamp + 
               RuleYes + 
               RuleFormal +  
               cogSC1 + 
               frgCV + 
               frg.left+   (1|Org) , family = binomial, data = td.fg) 
ss <- getME(hyps,c("theta","fixef"))
s1 <- update(hyps,start=ss,control=glmerControl(optimizer="bobyqa",
                                                 optCtrl=list(maxfun=2e5)))
# Wtr Otor
  #This is the best version, based on AIC scores and % variation explained...and is diff
  # from orig hypothesis.
hypwort<- glmer(Wotor ~ hhTenureWPast+ 
                  hhTenureWCamp + bondSC+ 
                  # otherPast+  # using dummy var now
                  othersIn +
                  othersOut +
                  RuleYes + 
                  RuleFormal+ 
                  frgCV + 
                  frg.left+  (1|Org) , family = binomial, data = td.fg) 
ss <- getME(hypwort,c("theta","fixef"))
wo1 <- update(hypwort,start=ss,control=glmerControl(optimizer="bobyqa",
                                                 optCtrl=list(maxfun=2e5)))
# Fall Otor
hypfo<- glmer(Fotor ~ # otherPast + # using DV now 
                  othersIn +
                  othersOut +
                  RuleYes + 
                  RuleFormal + 
                  cogSC1  +
                  bondSC + 
                  frgCV  + 
                  frg.left +   (1|Org) , family = binomial, data = td.fg) 
ss <- getME(hypfo,c("theta","fixef"))
fo1 <- update(hypfo,start=ss,control=glmerControl(optimizer="bobyqa",
                                                 optCtrl=list(maxfun=2e5)))
# Testing using DV vs. ordinal
# hypfodv<- glmer(Fotor ~ othersIn +
#                   othersOut +
#                   RuleYes + 
#                   RuleFormal + 
#                   cogSC1  +
#                   bondSC + 
#                   frgCV  + 
#                   frg.left +   (1|Org) , family = binomial, data = td.fg) 
# ss <- getME(hypfodv,c("theta","fixef"))
# fo1dv <- update(hypfodv,start=ss,control=glmerControl(optimizer="bobyqa",
#                                                  optCtrl=list(maxfun=2e5)))

# tab_model(fo1, fo1dv,
#           show.icc = TRUE,
#           show.aic = TRUE,
#           dv.labels = c( "Fall otor"),
#           rm.terms = "otherPast.Q",
#           pred.labels = pv,
#           p.style = "a")  # show asterisk instead of p val)

```


#TABLE 1

I guess it doesn't make sense to report the AIC values here, as they aren't comparabble across models, just useful for model selection for each
```{r}
# rename the variables so they make sense:
pv <- c(
  `(Intercept)` = "Intercept",
  cogSC1 = "Cognitive Social Capital",
  bondSC = "Structural Social Capital", 
  hhTenureWPast1 = "Winter Pasture Tenure", 
  hhTenureWCamp1 = "Winter Camp Tenure",
  hhTenureSpPast1 = "Spring Pasture Tenure",
  hhTenureSpCamp1 = "Spring Camp Tenure", 
  otherPast.L = "Access to Others' Pastures",
  # otherPast.Q = WHATS HAPPENING HERE
  RuleYes1 = "Rules on Timing of Grazing",
  RuleFormal1 = "Formal Rules on Timing",
  frg.left = "Remaining Forage Available",
  frgCV= "CV of Forage Availability",
  othersIn1 = "Access to Others' Pastures\n in Same Soum",
  othersOut1 = "Access to Others' Pasture\n in a Different Soum"
)
 
# set the order so taht the tenure parameters all appear together
tab_model(hypw, hyps, hypwort, hypfo,   
          show.icc = TRUE,
        #  show.aic = TRUE,
          dv.labels = c("Reserve Winter", "Reserve Spring", "Winter otor", "Fall otor"),
          pred.labels = pv,
          rm.terms = "otherPast.Q",  # remove the quadratic term
          p.style = "a")  # show asterisk instead of p val
```

#FIGURE 1
Plots of odds ratios for each model
```{r}
set_theme(  axis.textcolor = "black", 
  base = theme_bw())
a<- plot_model(hypw,
           title = "Reserve Winter Pastures", 
           sort.est = TRUE,
           auto.label = FALSE, 
           axis.labels = pv,
           axis.lim = c(0.25, 25),
           colors = "bw",
           rm.terms = "otherPast.Q",  # remove the quadratic term
           show.values = TRUE, value.offset = .3, value.size = 3
           ) 

b<- plot_model(hyps,
           title = "Reserve Spring Pastures", 
           sort.est = TRUE,
           auto.label = FALSE, 
           axis.labels = pv,
           colors = "bw",
           rm.terms = "otherPast.Q",  # remove the quadratic term
           show.values = TRUE, value.offset = .3, value.size = 3
           ) 

c<- plot_model(hypwort,
           title = "Winter otor", 
           sort.est = TRUE,
           auto.label = FALSE, 
           axis.labels = pv,
           colors = "bw",
           rm.terms = "otherPast.Q",  # remove the quadratic term
            show.values = TRUE, value.offset = .3, value.size = 3
           )
           
d<- plot_model(hypfo,
           title = "Fall otor", 
           sort.est = TRUE,
           auto.label = FALSE, 
           axis.labels = pv,
           colors = "bw",
           rm.terms = "otherPast.Q",  # remove the quadratic term
            show.values = TRUE, value.offset = .3, value.size = 3
           ) 

Fig1 <- cowplot::plot_grid(a,b,c,d, labels = 'auto', ncol = 2)
ggsave("./output_figs/Fig1.OddsRatios.png", Fig1, width = 11, height = 8, units = "in")
```

#FIGURE 2 
Predicted probability of reserving pastures based on Rule formality, cognitive social capital and tenure on the pasture/camp
```{r}
# rerun reserving pastures models with rules as ordinal not binary dummies
hypwR <- hypw<- glmer(ResWint ~ hhTenureWPast + 
               hhTenureWCamp + 
               Rule+  
               cogSC1 + 
               frgCV + 
               frg.left +   (1|Org) , family = binomial, data = td.fg)

# Resv Spr
hypsR<- glmer(ResSpr ~ hhTenureSpPast + 
               hhTenureSpCamp + 
               Rule +  
               cogSC1 + 
               frgCV + 
               frg.left+   (1|Org) , family = binomial, data = td.fg) 

#  PREDICTED DATA:
wdat<- get_model_data(hypwR, type = "pred", terms = c("cogSC1", "Rule", "hhTenureWPast"))

sdat<- get_model_data(hypsR, type = "pred", terms = c("cogSC1", "Rule", "hhTenureSpPast"))

# documentation says it is inefficient to use get_model_data, and i notice that it only genreates a few tsteps for the continuous vars.
# docs reco just using plot_model but I don't like how you can't modify plotting params easily.
# that just wraps ggeffects so maybeb just try that--> nope get same values
wdat <- wdat %>% mutate(
      Rules =    #  changed this to plural so the legend reads better
            recode(group,
                  "0" = "None",
                  "1" = "Informal",
                  "2" = "Formal"),
      hhTenureWPast =
           recode(facet,
                  "0"= "No tenure",
                  "1"= "Use/possession rights"))

sdat <- sdat %>% mutate(
      Rules =    #  changed this to plural so the legend reads better
            recode(group,
                  "0" = "None",
                  "1" = "Informal",
                  "2" = "Formal"),
      hhTenureSpPast =
           recode(facet,
                  "0"= "No tenure",
                  "1"= "Use/possession rights"))
# bw theme
set_theme(
  base = theme_light(),
  geom.outline.color = "antiquewhite4",
  geom.outline.size = 1,
  axis.title.size = .9,
  axis.textsize = .9,
  legend.size = .7,
  legend.title.size = .8,
  geom.label.size = 3
)

wsctr <- ggplot(wdat, aes( x= x, y = predicted, group = Rules)) +
  geom_smooth(aes(linetype = Rules), method = lm, se = FALSE, color = "black")+
  facet_wrap(vars(hhTenureWPast))+
  theme_bw()+
  labs(x ="Cognitive Social Capital", 
       y = "Predicted probability",
       title = "a)  Reserve Winter Pasture")

ssctr <- ggplot(sdat, aes( x= x, y = predicted, group = Rules)) +
  geom_smooth(aes(linetype = Rules), method = lm, se = FALSE, color = "black")+
  facet_wrap(vars(hhTenureSpPast))+
  theme_bw()+
  labs(x ="Cognitive Social Capital", 
       y = "Predicted probability",
       title = "a)  Reserve Spring Pasture")
# why does this version look different -- not linear. gah.
# plot_model(hypw, type = "pred", terms = c("cogSC1",  "Rule", "hhTenureWPast"))

ggsave("./output_figs/Fig2a.wpast_sctr.png", wsctr, 
       width = 6, height = 3, units = "in")

ggsave("./output_figs/Fig2b.spast_sctr.png", ssctr, 
       width = 6, height = 3, units = "in")

```

#FIGURE 3
Predicted probability of Otor based on Rule formality, cognitive social captial & access to other pastures

```{r}
# Gotta rerun Wtr Otor w the ordered version of Rules not binary
hypwoR<- glmer(Wotor ~ hhTenureWPast + hhTenureWCamp +otherPast + 
                  Rule + 
                  bondSC + 
                  cogSC1 +
                  frgCV  + 
                  frg.left +   (1|Org) , family = binomial, data = td.fg)


# Gotta rerun Fall Otor w the ordered version of Rules not binary
hypfoR<- glmer(Fotor ~ otherPast + 
                  Rule + 
                  cogSC1  +
                  bondSC + 
                  frgCV  + 
                  frg.left +   (1|Org) , family = binomial, data = td.fg) 

# THE ACTUAL PREDICTED DATA:
fodat<- get_model_data(hypfoR, type = "pred", terms = c("cogSC1", "Rule", "otherPast"))
wodat<- get_model_data(hypwoR, type = "pred", terms = c("bondSC", "Rule", "otherPast"))

# the code commented out below is the default plotting but I can't change the labels for levels
# so trying to do that with the actual predicted data first, then make plots on my own:

fodat <- fodat %>% mutate(
      Rules =
            recode(group,
                  "0" = "None",
                  "1" = "Informal",
                  "2" = "Formal"),
      otherPast =
           recode(facet,
                  "1"= "None",
                  "2"= "Within same soum",
                  "3"= "W/in & in others"))

wodat <- wodat %>% mutate(
      Rules =
            recode(group,
                  "0" = "None",
                  "1" = "Informal",
                  "2" = "Formal"),
      otherPast =
           recode(facet,
                  "1"= "None",
                  "2"= "Within same soum",
                  "3"= "W/in & in others"))


# bw theme
set_theme(
  base = theme_light(),
  geom.outline.color = "antiquewhite4",
  geom.outline.size = 1,
  axis.title.size = .9,
  axis.textsize = .9,
  legend.size = .7,
  legend.title.size = .8,
  geom.label.size = 3
)

foscop <- ggplot(fodat, aes( x= x, y = predicted, group = Rules)) +
  geom_smooth(aes(linetype = Rules), method = lm, se = FALSE, color = "black")+
  facet_wrap(vars(otherPast))+
  theme_bw()+
  labs(x ="Cognitive social capital", 
       y = "Predicted probability",
       title = "a)  Fall otor")

woscop <- ggplot(wodat, aes( x= x, y = predicted, group = Rules)) +
  geom_smooth(aes(linetype = Rules), method = lm, se = FALSE, color = "black")+
  facet_wrap(vars(otherPast))+
  labs(x ="Structural (networking) social capital", 
       y = "Predicted probability",
       title = "b)  Winter otor")
# foscop<- plot_model(hypfoR, type= "pred", 
#            terms = c("cogSC1", "Rule", "otherPast"), 
#            colors= "bw", 
#            ci.lvl = NA,
#            auto.label = FALSE,
#            axis.title= c("Cognitive Social Capital", "Predicted probability of going on fall otor"))
# 
# wobcop<- plot_model(hypwoR, type= "pred", terms = c("bondSC", "Rule", "otherPast"), colors= "bw", ci.lvl = NA, axis.title= c("Structural Social Capital", "Predicted probability of going on winter otor"))
# 
ggsave("./output_figs/Fig3a.fotorbyaccessandrules.png", foscop, width = 8, height = 3, units = "in")
ggsave("./output_figs/Fig3b.wotorbyaccessandrules.png", woscop, width = 8, height = 3, units = "in")
# 
# 
# plot_model(hypwoR, type= "pred", terms = c("cogSC1", "Rule", "otherPast"), colors= "bw", ci.lvl = NA)

```
#FIGURE 4
```{r}
library(MASS)
# bw theme
set_theme(
  base = theme_light(),
  geom.outline.color = "antiquewhite4", 
  geom.outline.size = 1, 
  axis.title.size = .9,
  axis.textsize = .9,
  legend.size = .7,
  legend.title.size = .8,
  geom.label.size = 3
)

rse1<- polr(Rule ~ cogSC1 + ez, data = td.fg, method = c("logistic"))

# FITTED VALS:
fit.rse<- rse1$fitted.values
colnames(fit.rse)<- c("None", "Informal", "Formal")
rse.df<- data.frame(fit.rse, rse1$model)
# New facet label names for ez variable
ez.labs <- c("DS", "ST", "ES", "FMS")
names(ez.labs) <- c("1", "2", "3", "4")

rse.df<- gather(rse.df, "Rules", "PredProb", 1:3)

rsez<- ggplot(rse.df, aes(x= cogSC1, y=PredProb, group= Rules )) +
  geom_smooth(aes(linetype = Rules), method = lm, se= FALSE, color = "black")+  
  #geom_line()+
  #geom_smooth(position=position_jitter(width=.01,height=.01))+
  coord_cartesian(xlim = c(0,2), ylim = c(0,0.75))+
  xlab("Cognitive social capital")+
  ylab("Pred Prob of Class Membership") +
  facet_grid(.~ez, labeller = labeller(ez = ez.labs)
)

ggsave("./output_figs/Fig4.predRulelevel.png", rsez, width = 7, height = 3, units = "in")
```


#FIGURE 6ab

Predicted probability of Reserving Pastures based on Rule formality, cognitive social captial  (REMOVED TENURE bc not signif :: & tenure)

```{r}
# Resv Wtr w ordered Rules param
hypwR<- glmer(ResWint ~ hhTenureWPast + 
               hhTenureWCamp + 
               Rule + 
               cogSC1 + 
               frgCV + 
               frg.left +   (1|Org) , family = binomial, data = td.fg) 
# Resv Spr w ordered Rules param
hypsR<- glmer(ResSpr ~ hhTenureSpPast + 
               hhTenureSpCamp + 
               Rule + 
               cogSC1 + 
               frgCV + 
               frg.left+   (1|Org) , family = binomial, data = td.fg) 


# bw theme
set_theme(
  base = theme_light(),
  geom.outline.color = "antiquewhite4", 
  geom.outline.size = 1, 
  axis.title.size = .9,
  axis.textsize = .9,
  legend.size = .7,
  legend.title.size = .8,
  geom.label.size = 3
)
a <- plot_model(hypwR, type= "pred", 
           terms = c("cogSC1", "Rule"), 
           colors= "bw", 
           ci.lvl = NA,
           axis.title= c("Cognitive Social Capital", "Predicted prob. of reserving winter pasture"), title = " ")

b <- plot_model(hypsR, type= "pred", 
                terms = c("cogSC1", "Rule" ), 
                colors= "bw", 
                ci.lvl = NA, 
                axis.title= c("Cognitive Social Capital", "Predicted prob. of resrvs spring pasture"),title = " ")


#scr<-cowplot::plot_grid(a,b, labels = 'auto', ncol = 2)


#ggsave("Fig6.rsvbyscandrules.png", scr, width = 7, height = 4, units = "in")




```


#FIGURE 6cd
Predicted probability of Reserving Pastures based on Rule formality,  & remaining forage

```{r}


# bw theme
set_theme(
  base = theme_light(),
  geom.outline.color = "antiquewhite4", 
  geom.outline.size = 1, 
  axis.title.size = .9,
  axis.textsize = .9,
  legend.size = .7,
  legend.title.size = .8,
  geom.label.size = 3
)
c <- plot_model(hypwR, type= "pred", 
           terms = c("frg.left", "Rule"), 
           colors= "bw", 
           ci.lvl = NA,
           axis.title= c("Forage remaining at end of season", "Predicted prob. of reserving winter pasture"), title = "")

d <- plot_model(hypsR, type= "pred", 
                terms = c("frg.left", "Rule"), 
                colors= "bw", 
                ci.lvl = NA, 
                axis.title= c("Forage remaining at end of season", "Predicted prob. of resrvs spring pasture"),title = "")




fgr<- cowplot::plot_grid(a,b,c,d,  labels = 'auto', ncol = 2)


ggsave("Fig6.rsvpast_scfrgandrules.png", fgr, width = 7, height = 8, units = "in")



```




#FIGURE Supplement 1 :  Access x social capital

```{r}
td.op<- mor2FULL%>% dplyr::select( #Rule = q03_TimingRules3.3,       # Rule formality 
                                #** Cognitive Social Capital :          
                                # see Ulambayar et al. (201?) for info on which Qs were used, how combined
                                cogSC1 = CognSC,   
                                bondSC = BondSCsum,        # sum of five bonding items 7.6a-e
                                #Access to other pastures:
                                accPast = CanUseOtherPast)

td.op<- mutate(td.op, otherPast = case_when(accPast == 3 ~ 1,   # No set to 1
                                      accPast == 1 ~ 2,   # Yes w/in Soum set to 2
                                      accPast == 2 ~ 3,   # Yes w/in & other soums set to 3
                                      TRUE ~ NA_real_))
 # Other set to NA
td.op<- td.op[,c(1,2,4)]
td.op$otherPast<- as.factor(td.op$otherPast)
td.op$cogSC1<- as.numeric(td.op$cogSC1)
td.op$bondSC<- as.numeric(td.op$bondSC)
#td.op$Rule<- as.factor(td.op$Rule)
td.op <- na.omit(td.op)
td.op<-as.data.frame(td.op)
library(plyr)

# for some reason when I change the names of the levels in a factor so that the axes are
# labelled correctly, then I can't change the axis labels??
#td.op$otherPast <- revalue(td.op$otherPast, c("1" = "No", "2" = "Within soum", "3"= "In other soums"))

accessAOV<- aov(cogSC1 ~ otherPast, data = td.op)
summary(accessAOV)

TukeyHSD(accessAOV)
# tells us that 2 is diff from 1 and 3 is diff from 1 but 2 & 3 are not diff, 
# therefore access in or in and out are both associated with higher cogSC, but 
# to same degree.

bcAOV<- aov(bondSC ~ otherPast, data = td.op)
summary(bcAOV)

TukeyHSD(bcAOV)

 # corr  btwn cogSC1 and access to Past in soums only
corrplot(hetcor(td.op)$cor, 
         type = "lower", method = "number", 
         number.cex = 2, diag = FALSE)

library(ggsignif)
aop<- ggplot(td.op, aes(x=otherPast, y= cogSC1)) + 
  geom_boxplot()+
  geom_signif(comparisons = list(c("1", "2")), map_signif_level = TRUE, y_position = 2.2, tip_length = 0.01)+
   geom_signif(comparisons = list( c("2", "3")), map_signif_level = TRUE, y_position = 2.4, tip_length = 0.01)+
   geom_signif(comparisons = list( c("1", "3")), map_signif_level = TRUE, y_position = 2.6, tip_length = 0.01)+
  labs(y = "Cognitive Social Capital",x = "Access to Other Pastures")+
  ylim(0,3)+
  theme_bw()


ggsave("accessOtherxCSC.png", aop, width = 4, height = 3, units = "in")

bcaop<- ggplot(td.op, aes(x=otherPast, y= bondSC)) + 
  geom_boxplot()+
  geom_signif(comparisons = list(c("1", "2")), map_signif_level = TRUE, y_position = 5.2, tip_length = 0.01)+
   geom_signif(comparisons = list( c("2", "3")), map_signif_level = TRUE, y_position = 5.4, tip_length = 0.01)+
   geom_signif(comparisons = list( c("1", "3")), map_signif_level = TRUE, y_position = 5.8, tip_length = 0.01)+
  labs(y = "Structural Social Capital",x = "Access to Other Pastures")+
  ylim(0,6)+
  theme_bw()

ggsave("accessOtherxBSC.png", bcaop, width = 4, height = 3, units = "in")

```



# old explanation about how to hand calculate predictions----
Based on the above, the formula for Reserving winter pastures is: 
Prob Reserve WPast ~ -6.059621 + (0.662 * TenureWPast) + (0.518 * TenureWCamp) + (1.308847 * RuleYes) + (-0.215351 * RuleFormal) + (0.812 * cogSC1) + (0.048 * frg.left) + (0.046 * frgCV)


Another way to show it: The odds of reserving are = exp(everything above)
Or, we can convert that to probability of reserving with:
p= 1/(1+exp(-(everything above)))

Now we calculate a new column in the dataframe for the estimated probability of each value of X1 using the mean of X2 with the formula:

1/(1+exp(-(B0 + B1X1 + B2MeanX2 + ...))


CAN SHORTEN ALL OF THIS (vc'd and deleted) BY JUST USING THE FUNCTIONS IN sjPlot! Such as 
plot_model(x, type = "pred")
"Model predictions are based on all possible combinations of the model terms, which are - roughly speaking - created using expand.grid(). For the terms in question, all values are used for combinations. All other model predictors that are not specified in the terms-argument, are held constant (which is achieved with sjstats::typical_value()). By default, continuous variables are set to their mean, while factors are set to their reference level." <- from the documentation for sjPlot. This is essentially what I've done farther below.

NOTE: FIG VIZ PARAMS to USE:
           title = "Fall otor", 
           sort.est = TRUE,
           auto.label = FALSE, 
           axis.labels = pv,
           colors = "bw",
           rm.terms = "otherPast.Q",  # remove the quadratic term
            show.values = TRUE, value.offset = .3, value.size = 3


# OLD - 4. Predicted probabilities 
Examine the influence of each predictor on the predicted probabilities, either holding all other constant, or examine the interactions of terms:
(all remaining binary predictors held at 0, continuous params set to their mean)

THIS IS HOW TO PLOT THEM WITH ALL DATA COMBINED-- NOT SEPARATED OUT BY ECOLOGICAL ZONE
```{r}
plot_model(hypfo)
plot_model(hypfo, type = "pred")
plot_model(hypfo, type = "pred", terms = c("cogSC1"))
#plot_model(hypfez, type = "pred", terms = c("cogSC1", "RuleFormal", "ez"))
#plot_model(hypfez, type = "pred", terms = c("cogSC1", "RuleFormal"))

```


##Predicted Odds of Otor

Relationship between access to pastures, social and rules as predictors of fall and winter otor.
```{r}
hypfor<- glmer(Fotor ~ otherPast + 
                  Rule + 
                  cogSC1  +
                  bondSC + 
                  frgCV  + 
                  frg.left +   (1|Org) , family = binomial, data = td.fg) 
plot_model(hypfor, type= "pred", terms = c("cogSC1",  "Rule"),
           colors = "bw",
           title = "Predicted odds of fall otor")

hypwor<- glmer(Wotor ~ hhTenureWPast+ 
                  hhTenureWCamp+bondSC+ 
                  otherPast+ 
                  Rule + 
                  cogSC1 +
                  #RuleFormal+ 
                  frgCV + 
                  frg.left+  (1|Org) , family = binomial, data = td.fg) 
  # winter otor
a<- plot_model(hypwor, type= "pred", terms = c("cogSC1", "Rule", "otherPast"),
           colors = "bw",
           title = "Predicted odds of winter otor with access to other pastures")
# Fall Otor
  # with CIs
b<- plot_model(hypfor, type= "pred", terms = c("cogSC1", "Rule", "otherPast"),
           colors = "bw",
           title = "Predicted odds of fall otor with access to other pastures",
           ci.lvl = NA)   # to remove CIs

cowplot::plot_grid(a,b, labels = 'auto', ncol = 1)

```

```{r}

```


 Past given CV of forage over past X yrs (all other params constant)


```{r, eval = FALSE}
# visualizing the varation in intercepts across the Orgs.

int<- hypw@beta
wint<- int[1]
# explore the variation in intercepts across Orgs:
org<- coef(hypw)
Worg<- org$Org 
# Rename a column in R
colnames(Worg)[colnames(Worg)=="(Intercept)"] <- "Int"


ggplot(Worg, aes(x= (Int))) + geom_density() + geom_vline(xintercept = wint)+
  ggtitle("variation in intercept across Orgs")
 
```


```{r,eval=FALSE}
# visualizing the varation in intercepts across the Orgs.

int<- bestSp@beta
Spint<- int[1]
# explore the variation in intercepts across Orgs:
org<- coef(bestSp)
Sorg<- org$Org 
# Rename a column in R
colnames(Sorg)[colnames(Sorg)=="(Intercept)"] <- "Int"


ggplot(Sorg, aes(x= (Int))) + geom_density() + geom_vline(xintercept = Spint)


```

**Interpretting the odds ratios:**  tenure on the spring pasture, membership in a formal CBRM and cognitive social capital all increase the odds that a household will reserve the spring pastures. Rules (re: timing of grazing) were not significant, but the coeffs indicate that the negative impact of NOT having rules on the odds of reserving pasture.. Conditional R2 describes the proportion of variance explained by both the fixed and random factors ... which, doesn't seem great?


In the meantime, here's the original and predicted values. 
To visualize will have to decide a cut-off point for the fitted to assign 0/1
```{r }
# code adapted from Stats of Doom
df.hypfo<- hypfo@frame
foDat <- data.frame(hypfo@frame, resid=residuals(hypfo,type="pearson"),fitted=fitted(hypfo))

theme= theme(panel.grid.major = element_blank(),
             panel.grid.minor = element_blank(),
             panel.background = element_blank(),
             axis.text.y = element_blank(),
             axis.ticks = element_blank(),
             axis.line.x = element_line(color = "black"),
             axis.line.y = element_line(color = "black"),
             text = element_text(size = 20),
             legend.key = element_blank())
hist = ggplot(foDat, aes(fitted, color = Fotor, fill = Fotor))
hist +
  theme +
  geom_dotplot(binwidth = 0.01, position = "jitter")+
  coord_cartesian(xlim = c(0,1))+
  xlab("fitted value for probability untertake otor")+
  ylab(" ")+
  scale_color_manual(values = c("Maroon", "#2C3539"), #change
                     labels = c("Do Not Reserve", "Reserve"),
                     name = "Fall Otor")+
  scale_fill_manual(values = c("Maroon", "#2C3539"), #change
                     labels = c("Do Not Reserve", "Reserve"),
                     name = "Fall Otor")+
  geom_vline(xintercept = c(0.5), linetype = "dotdash", size = 1)



```

```{r}

# histogram of predicted values, colored by Rule formality 
ggplot(foDat, aes(fitted, color= RuleYes)) + geom_density() 
ggplot(foDat, aes(fitted, color= otherPast)) + geom_density() 
#ggplot(foDat, aes(fitted, color= cbrmYN)) + geom_density() 

# boxplot of fitted values by Rule and hh Tenure on W Pasture
f<- ggplot(foDat, aes(x=RuleYes, y = fitted))
f+ geom_boxplot() +
  theme_bw() +
  xlab("Rule formality")+
  ylab("predicted probability reserve patures") +
  facet_grid(.~otherPast) 
  

```




### SOCIAL CAPITAL & RULES ...  

Given what we see above wrt the (weak) relationship between (this particular set of) Rules and (this one) Practice, does this mean for our hypothesized relationships between Social Capital and the prevalance of Informal vs. Formal Rules? Does it vary by TYPE of pasture/season under consideration? Stronger relationship between rule formality and social capital for the Winter pastures compared to Spring pastures.



**Original Hypothesis:**  
  Increased cognitive social capital will lead to more prevalence of *informal* rules (within certain ecological zones)
  Rules ~ Social Capital + ecological zone

But is there a chance that we have the order/direction of causality wrong in that?
  It could be Soc Cap ~ Rules + ez
    - or -
  Soc Cap ~ Rules + (1|ez)  NO. More likely Rule as a results of SC not other way around.
  
#### SC1 
```{r, message = FALSE, warning= FALSE}
library(MASS)
# need to use MASS::polr for ordered logistic regression
rezm<- polr(Rule ~ ez, data = td.fg, method = c("logistic"))
rscm<- polr(Rule ~ cogSC1 , data = td.fg, method = c("logistic"))

#anova(rezm, rscm) # big improvement by including ez, as we predicted
summary(rse1) # outputs are re: prob of being in that class or lower
#intercepts are the zetas
focal.predictors <- c("cogSC1", "ez")
mod <- rse1
xlevels <- list(cogSC1=8, ez=c(1,2,3,4))
Effect(focal.predictors, mod,
       xlevels= list(cogSC1=8, ez=c(1,2,3,4)), 
       #fixed.predictors,
       vcov.=vcov, se=TRUE, 
       latent=FALSE)



#  Tenure as predicted by Rule formality and EZ
rtez<- glm(hhTenureWPast ~ Rule + ez +cogSC1, data= td, family = "binomial")
summary(rtez)
# :
rtez_dat <- cbind(expand.grid(Rule=c(0,1,2),  ez = rep(1:4, 100), cogSC1=seq(0,2, 0.25))) #hhTenureWPast= c(0,1),
rtez_dat <- cbind(expand.grid(Rule=c(0,1,2),  ez = rep(1:4), cogSC1=seq(0,2, 0.25))) #hhTenureWPast= c(0,1),

# start w just one value for each
#fo_dat <- cbind(expand.grid(otherPast=c(1,2,3),Rule=c(0,1,2), hhTenureWPast= c(0,1), cogSC1=seq(0,2, 0.25)))

rtez_dat %<>% mutate_at(1, funs(ordered(.)))
rtez_dat %<>% mutate_at(c(2), funs(factor(.)))

rtezPred <- predict(rtez, rtez_dat, type="response")
rtezpredDat <- data.frame(rtez_dat, rtezPred)

#rnewdat<- cbind(rtez_dat, predict(rtez, rtez_dat, type = "response"))
# this doesn't work bc not ordered response....
#rtnewdat <- data.table::melt(rnewdat, id.vars = c("cogSC1", "ez"),
 #                variable.name = "Rule_Level", value.name = "Probability")


# scm<- lm(cogSC1 ~ ez, data =td, method = c("logistic"))
# scm1<- lm(cogSC1 ~ Rule, data =td, method = c("logistic"))
# anova(scm, scm1)
# scm<- glmer(cogSC1 ~ Rule + (1|ez), data =td)
# summary(scm)



# ggplot(lnewdat, aes(x= cogSC1, y= Probability, color = Rule_Level))+
#   geom_smooth()+
#     facet_grid(.~ez)+
#   # coord_cartesian(xlim = c(0,2), ylim = c(0,0.75))+
#   xlab("Cognitive Social Capital")+
#   ylab("Pred Prob of Class Membership") 

ggplot(rtezpredDat, aes(x= cogSC1, y= rtezPred, color = Rule))+
  geom_smooth()+
  facet_grid(.~ez)+
   #coord_cartesian(xlim = c(0,2), ylim = c(0,0.75))+
  xlab("Cognitive Social Capital")+
  ylab("Pred Prob of Class Membership") 


ggplot(rtezpredDat, aes(x= rtezPred, y= cogSC1))+
  geom_bin2d()+
  facet_grid(ez~Rule)+
   #coord_cartesian(xlim = c(0,2), ylim = c(0,0.75))+
  xlab("Cognitive Social Capital")+
  ylab("Pred Prob of Class Membership") 
```

Big improvement by including ez, as we predicted

# returns predicted class membership, so look for the highest estimated probability in each zone.
Edit this to create a table:
```{r}
# EZ = 1
predict(rse1, newdata = data.frame(ez="1"),type="p") #0 = No rules, Inf next
# EZ = 2
predict(ezm, newdata = data.frame(ez="2"),type="p") #1 = Inf, formal next
#EZ = 3
predict(ezm, newdata = data.frame(ez="3"),type="p") #1 = Inf, then no, then formal
#EZ = 4
predict(ezm, newdata = data.frame(ez="4"),type="p") #1 = Inf, then formal next


# calc cumulative probabilities of having certain rule formality:
exp(ezm$zeta - ezm$coefficients)/(1 + exp(ezm$zeta - ezm$coefficients))

# how would this apply w a 
exp(rse1$zeta - rse1$coefficients)/(1 + exp(rse1$zeta - rse1$coefficients))


#ggplot(scm.df, aes(x=)) 
```






  


```{r}
ggplot(td.fg, aes(x= frg.left, y = frgCV, color = ez)) + 
  geom_point() +
  xlab("Percent Forage Remain")+
  ylab("LT CV of % Forage Use")
  
```


